#!/usr/bin/env bash

# Backup docs.
# Naive approach, 2025-11-21 SAT
# Ideas for improvement: skip mounting, use rsync instead; also backup to google/proton; give src/dest via command line

mount_dir="/mnt/speedport"
doc_dir_local="$HOME/docs"
doc_dir_backup="$mount_dir/docs/backup"

# mount network storage
if ! mountpoint -q "$mount_dir"; then
  sudo mount -t cifs //192.168.2.1/Share "$mount_dir" -o guest,vers=1.0,uid="$(id -u)",gid="$(id -g)",file_mode=0755,dir_mode=0755,noperm
else
  echo "Storage already mounted"
fi

# run tar. exclude dev dirs.
# backup_file="$doc_dir_backup/docs-$(date +%Y-%m-%d).tar.gz"
# echo "Backing docs up to $backup_file"
# tar -czvf "$backup_file" --exclude "*/node_modules/*" --exclude "*/.venv/*" --exclude-vcs "$doc_dir_local"

# sync dirs via rsync -- saves time
# NOTE: with --delete, backup dir will be a mirror, i.e. other files will be deleted
# NOTE: symlinks are a pain
rsync -avh --delete --delete-excluded no-links \
  --exclude 'node_modules/' \
  --exclude '.venv/' \
  --exclude '.git/' \
  --exclude 'itemis_CREATE' \
  "$doc_dir_local/" \
  "$doc_dir_backup/"
# DEBUG
# ls "$doc_dir_backup"

cleanup() {
  sudo umount "$mount_dir" 2>/dev/null
}
trap cleanup EXIT
